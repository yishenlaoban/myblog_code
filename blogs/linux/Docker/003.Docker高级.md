## Docker上软件复杂安装

### 1、Mysql主从复制

:::tip 1.新建主服务器容器3307

```shell
docker run -p 3307:3306 --name mysql-master 
-v /mydata/mysql-master/log:/var/log/mysql 
-v /mydata/mysql-master/data:/var/lib/mysql 
-v /mydata/mysql-master/conf:/etc/mysql 
-e MYSQL_ROOT_PASSWORD=root  
-d mysql:5.7
```

​	![image-20220616113208132](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616113208441-1472280881.png)  

:::



:::tip 2.进入/mydata/mysql-master/conf目录下新建my.cnf

```
cd /mydata/mysql-master/conf
vim my.cnf
```

> [mysqld]
>
> \## 设置server_id，同一局域网中需要唯一
>
> server_id=101 
>
> \## 指定不需要同步的数据库名称
>
> binlog-ignore-db=mysql 
>
> \## 开启二进制日志功能
>
> log-bin=mall-mysql-bin 
>
> \## 设置二进制日志使用内存大小（事务）
>
> binlog_cache_size=1M 
>
> \## 设置使用的二进制日志格式（mixed,statement,row）
>
> binlog_format=mixed 
>
> \## 二进制日志过期清理时间。默认值为0，表示不自动清理。
>
> expire_logs_days=7 
>
> \## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
>
> \## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
>
> slave_skip_errors=1062

:::



:::tip 3.重启master实例

```shell
docker restart mysql-master
```

![image-20220616150514508](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616150514877-1490082655.png) 

:::



:::tip 4.进入mysql-master容器

```shell
docker exec -it mysql-master bash
mysql -uroot -p
```

![image-20220616151024787](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616151025019-519565671.png) 

:::



:::tip 5.master容器实例上创建数据同步用户

```shell
create user 'slave'@'%' identified by '123456';
grant replication slave,replication client on *.*to'slave'@'%';
```

![image-20220616151717368](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616151717639-1367493840.png) 

:::



:::tip 6.新建从服务器容器3308

```shell
docker run -p 3308:3306 --name mysql-slave 
-v /mydata/mysql-slave/log:/var/log/mysql 
-v /mydata/mysql-slave/data:/var/lib/mysql 
-v /mydata/mysql-slave/conf:/etc/mysql 
-e MYSQL_ROOT_PASSWORD=root  
-d mysql:5.7
```

![image-20220616152706223](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616152706619-1042942807.png) 

:::



:::tip 7.进入/mydata/msql-slave/conf 目录下创建 my.cnf 

> [mysqld]
>
> \## 设置server_id，同一局域网中需要唯一
>
> server_id=102
>
> \## 指定不需要同步的数据库名称
>
> binlog-ignore-db=mysql 
>
> \## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用
>
> log-bin=mall-mysql-slave1-bin 
>
> \## 设置二进制日志使用内存大小（事务）
>
> binlog_cache_size=1M 
>
> \## 设置使用的二进制日志格式（mixed,statement,row）
>
> binlog_format=mixed 
>
> \## 二进制日志过期清理时间。默认值为0，表示不自动清理。
>
> expire_logs_days=7 
>
> \## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
>
> \## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
>
> slave_skip_errors=1062 
>
> \## relay_log配置中继日志
>
> relay_log=mall-mysql-relay-bin 
>
> \## log_slave_updates表示slave将复制事件写进自己的二进制日志
>
> log_slave_updates=1 
>
> \## slave设置为只读（具有super权限的用户除外）
>
> read_only=1

<Badge text='重启slave实例' type='danger'/>

:::



:::tip 8.在主数据库中查看主从同步状态

```mysql
show master status
```

![image-20220616154944717](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616154945374-71902092.png) 

:::



:::tip 9.在从数据库设置主从复制

```shell
docker exec -it mysql-slave bash
mysql -uroot -p

#修改配置（认老大）
change master to master_host='宿主机ip', master_user='slave', master_password='123456', master_port=3307, master_log_file='mall-mysql-bin.000001', master_log_pos=617, master_connect_retry=30;
```

![image-20220616160815130](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616160815558-541753090.png)

> **`主从复制参数：`**
>
> master_host：主数据库的IP地址；
>
> master_port：主数据库的运行端口；
>
> master_user：在主数据库创建的用于同步数据的用户账号；
>
> master_password：在主数据库创建的用于同步数据的用户密码；
>
> master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数；
>
> master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；
>
> master_connect_retry：连接失败重试的时间间隔，单位为秒。 

:::



:::tip 10.从数据库查看主从复制状态，开启主从复制

```shell
show slave status \G;
start slave;
```

![image-20220616161252587](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616161252823-1024576173.png) 

![image-20220616163401599](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616163402388-1182820959.png) 

:::



:::tip 11.主从复制测试

主机创建数据库--> 创建表--->插入数据

```shell
create database db1;
use db1;
create table t1(id int,name varchar(20));
```

![image-20220616164424953](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616164425279-629580441.png) 

检查从数据库的数据是否同步了

![image-20220616165354941](https://img2022.cnblogs.com/blog/2346254/202206/2346254-20220616165355603-52925751.png) 

:::